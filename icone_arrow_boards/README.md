# iCone Arrow Board Testing Scripts
This directory contains scripts for testing iCone enabled arrow board cloud data sync and generating reports about the locations and on-times of iCone enabled arrow boards.

## Cloud Sync Testing
These scripts collect data from the iCone FTP server, which can be used to confirm communication and various functions of the arrow boards. These scripts were designed to test connectivity (confirm that a sign is visible) and verifying the different arrow board states (left arrow, right arrow, etc.). 

### get_icone.py
This script will pull the latest iCone messages from an FTP server, for use in verifying the functionality of iCone enabled arrow boards. The script will download the `incidents_extended.xml` file from the iCone FTP server and save it to the `data` directory. This script also prints the ID, update_time, and current state of each of the devices. 

### log_icone.py
This script constantly logs results from the iCone FTP server to a single log file. This log file contains ID, update_time, state, and position of each sensor. By default, it pulls data every 5 minutes, until the script is closed. These log files are used to verify state changes and connectivity of the arrow boards.

### process_icone_logs.py
This script processes the log files generated by `log_icone.py` and generates a CSV file with the following columns: `ID`, `update_time`, `state`, `position`, `latitude`, `longitude`. This CSV contains entries for each device, noting the start and end broadcast times for each state. This script is used to generate reports on the locations and on-times of iCone enabled arrow boards.

## Report Generation
These scripts generate reports based on the data collected from the iCone FTP server. These reports are used to analyze the locations and on-times of iCone enabled arrow boards. Data for these reports is generated using either data collected from the two scripts noted above, or from a [cdot-oim-cv-dev google cloud bucket](https://console.cloud.google.com/storage/browser/cdot-cv-icone-data?authuser=1&project=cdot-oim-cv-dev&pageState=(%22StorageObjectListTable%22:(%22f%22:%22%255B%255D%22))&prefix=&forceOnObjectsSortingFiltering=false). This bucket contains archived XML files from the iCone FTP server every 5 minutes. 

### final_icone_report.py
This script generates a report on the locations and on-times of iCone enabled arrow boards. This script reads all the XML files from a directory, and collects them by ID, state, and position. The script then generates a JSON file with the following columns: `ID`, `states`, `coordinates`, `route`, `start_time`, `end_time`, `mm_min`, and `mm_max`. For each device, this report contains entries for each on/off change, state change, and position change. This script also utilizes the WZDx library to get start/end mile marker values for each device.

### final_icone_report_formatter.py
This script formats the JSON file generated by `final_icone_report.py` into a cleaner JSON file. This was separated as both formats can be useful for different purposes. 

**Important Note: This script is intended to run from the root of this reporitory, and is stored here for organizational purposes**


## Environment Variables

| Name                 |          Value           |                                    Description |
| :------------------- | :----------------------: | ---------------------------------------------: |
| ICONE_USERNAME         |       cdot       |                      iCone FTP server username |
| ICONE_FILE_PATH        | incidents_extended.xml |                     Path to file on FTP server |
| ICONE_PASSWORD |           - *hidden* -       | iCone FTP server password |
